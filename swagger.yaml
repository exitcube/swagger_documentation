openapi: 3.0.0
info:
  title: Shinr User Management API
  version: "1.0.0"
  description: API documentation for login and OTP verification

servers:
  - url: https://shinr-user-mgmt.onrender.com/

tags:
  - name: Auth
    description: Authentication endpoints
  - name: User Profile
    description: User profile and location endpoints
  - name: Vehicle
    description: Vehicle-related endpoints for fetching car details

paths:
  /user/login/otp:
    post:
      tags:
        - Auth
      summary: Generate OTP for login
      description: Sends an OTP token for a mobile number. Creates user/device if not exists.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - mobile
              properties:
                mobile:
                  type: string
      responses:
        "200":
          description: OTP generated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessOtpTokenResponse'
        "400":
          $ref: '#/components/responses/BadRequestError'
        "500":
          $ref: '#/components/responses/InternalServerError'

  /user/login/verify-otp:
    post:
      tags:
        - Auth
      summary: Verify OTP and generate access & refresh tokens
      description: Verifies the OTP for a user device and returns JWT tokens.
      parameters:
        - in: header
          name: x-device-id
          required: true
          schema:
            type: string
          description: The unique ID of the device making the request
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - otpToken
                - otp
              properties:
                otpToken:
                  type: string
                otp:
                  type: string
      responses:
        "200":
          description: OTP verified successfully and tokens generated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessAuthTokensResponse'
        "400":
          $ref: '#/components/responses/BadRequestError'
        "500":
          $ref: '#/components/responses/InternalServerError'

  /user/login/resend-otp:
    post:
      tags:
        - Auth
      summary: Resend OTP for a user device
      description: |
        Resends an OTP for a user device. 
        Validates the device, checks request count and cooldown (45 seconds), and generates a new OTP and token.
      parameters:
        - in: header
          name: x-device-id
          required: true
          schema:
            type: string
          description: The unique ID of the device making the request
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - otpToken
              properties:
                otpToken:
                  type: string
                  description: The token from the previous OTP request
      responses:
        "200":
          description: OTP resent successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessOtpTokenResponse'
        "400":
          $ref: '#/components/responses/BadRequestError'
        "429":
          $ref: '#/components/responses/TooManyRequestsError'
        "500":
          $ref: '#/components/responses/InternalServerError'

  /user/login/generate-refreshToken:
    post:
      tags:
        - Auth
      summary: Refresh Access and Refresh Tokens
      description: >
        Refreshes the user's access and refresh tokens using a valid refresh token.  
        The endpoint validates the refresh token, device identity, and user status before issuing new tokens.
      parameters:
        - in: header
          name: x-device-id
          required: true
          schema:
            type: string
          description: The unique ID of the device making the request
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - refreshToken
              properties:
                refreshToken:
                  type: string
                  description: The refresh token issued during login.
      responses:
        "200":
          description: Tokens refreshed successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessAuthTokensResponse'
        "400":
          $ref: '#/components/responses/BadRequestError'
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "500":
          $ref: '#/components/responses/InternalServerError'
      security: []

  /user/logout:
    post:
      tags:
        - Auth
      summary: Logout user and invalidate tokens
      description: |
        Logs out the currently authenticated user from the specified device.  
        Invalidates all active refresh tokens for that device and removes the device record from the database.
      security:
        - bearerAuth: []
      parameters:
        - in: header
          name: x-device-id
          required: true
          schema:
            type: string
          description: Unique device identifier for the user session
      responses:
        "200":
          description: Logged out successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessMessageOnly'
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "404":
          $ref: '#/components/responses/NotFoundError'
        "500":
          $ref: '#/components/responses/InternalServerError'

  /user-profile/location-autocomplete:
    get:
      tags:
        - User Profile
      summary: Get location suggestions by search query
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: search
          required: true
          schema:
            type: string
            minLength: 3
        - in: header
          name: x-device-id
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Autocomplete results fetched successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessLocationAutocompleteResponse'
        "400":
          $ref: '#/components/responses/BadRequestError'
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "500":
          $ref: '#/components/responses/InternalServerError'

  /user-profile/get-location/reverse-geocode:
    post:
      tags:
        - User Profile
      summary: Get address from latitude and longitude
      security:
        - bearerAuth: []
      parameters:
        - in: header
          name: x-device-id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [lat, lng]
              properties:
                lat:
                  type: string
                lng:
                  type: string
      responses:
        "201":
          description: Address fetched successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessAddressResponse'
        "400":
          $ref: '#/components/responses/BadRequestError'
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "500":
          $ref: '#/components/responses/InternalServerError'

  /user-profile/add-address:
    post:
      tags:
        - User Profile
      summary: Add a new address for the user
      security:
        - bearerAuth: []
      parameters:
        - in: header
          name: x-device-id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
                - addressLine1
                - country
                - city
                - state
                - pinCode
                - latitude
                - longitude
              properties:
                nickName:
                  type: string
                name:
                  type: string
                addressLine1:
                  type: string
                country:
                  type: string
                city:
                  type: string
                state:
                  type: string
                pinCode:
                  type: string
                latitude:
                  type: number
                longitude:
                  type: number
      responses:
        "201":
          description: Address saved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessAddressResponse'
        "400":
          $ref: '#/components/responses/BadRequestError'
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "500":
          $ref: '#/components/responses/InternalServerError'

  /user-profile/remove-address/{id}:
    post:
      tags:
        - User Profile
      summary: Remove an address by ID
      security:
        - bearerAuth: []
      parameters:
        - in: header
          name: x-device-id
          required: true
          schema:
            type: string
        - in: path
          name: id
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Address removed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessMessageOnly'
        "400":
          $ref: '#/components/responses/BadRequestError'
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "404":
          $ref: '#/components/responses/NotFoundError'
        "500":
          $ref: '#/components/responses/InternalServerError'

  /user-profile/select-address/{id}:
    post:
      tags:
        - User Profile
      summary: Select an address by ID
      security:
        - bearerAuth: []
      parameters:
        - in: header
          name: x-device-id
          required: true
          schema:
            type: string
        - in: path
          name: id
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Address selected successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessSelectedAddressResponse'
        "400":
          $ref: '#/components/responses/BadRequestError'
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "404":
          $ref: '#/components/responses/NotFoundError'
        "500":
          $ref: '#/components/responses/InternalServerError'

  /car:
    get:
      tags:
        - Vehicle
      summary: Fetch cars with filtering, sorting, and pagination
      description: >
        Fetches active cars based on filters such as model, make, and category. Requires authorization.
      operationId: getCars
      security:
        - bearerAuth: []
      parameters:
        - name: x-device-id
          in: header
          required: true
          schema:
            type: string
        - name: search
          in: query
          schema:
            type: string
        - name: makeId
          in: query
          schema:
            type: integer
        - name: categoryId
          in: query
          schema:
            type: integer
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 10
        - name: sortOrder
          in: query
          schema:
            type: string
            enum: [asc, desc]
            default: asc
      responses:
        "200":
          description: Cars fetched successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessCarsResponse'
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "404":
          $ref: '#/components/responses/NotFoundError'
        "500":
          $ref: '#/components/responses/InternalServerError'

  /cars/car-brands:
    get:
      tags:
        - Vehicle
      summary: Fetch car brands (makes)
      description: >
        Retrieves paginated list of car brands.
      operationId: getCarsBrandHandler
      security:
        - bearerAuth: []
      parameters:
        - in: header
          name: x-device-id
          required: true
          schema:
            type: string
        - in: query
          name: page
          schema:
            type: integer
            default: 1
        - in: query
          name: limit
          schema:
            type: integer
            default: 10
      responses:
        "200":
          description: Car brands fetched successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessCarBrandsResponse'
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "500":
          $ref: '#/components/responses/InternalServerError'

  /service/add-service:
    post:
      tags:
        - Service
      summary: Add a new service
      description: Creates a new service with name, display name, image reference, and target value.
      security:
        - bearerAuth: []
      parameters:
        - in: header
          name: x-device-id
          required: true
          schema:
            type: string
          description: Unique device identifier for the request
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AddServiceRequest"
      responses:
        "201":
          description: Service added successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SuccessAddServiceResponse"
        "400":
          description: Invalid input data
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized - Invalid or missing token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Failed to add service
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"


components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:

    # Generic success with only message
    SuccessMessageOnly:
      type: object
      properties:
        message:
          type: string
          example: Operation completed successfully

    # OTP token responses (used for generate & resend)
    SuccessOtpTokenResponse:
      type: object
      properties:
        message:
          type: string
          example: OTP resent successfully
        data:
          type: object
          properties:
            otpToken:
              type: string
              example: eyJhbGciOiJIUzI1NiIsInR5cCI...

    # Auth tokens response (verify and refresh)
    SuccessAuthTokensResponse:
      type: object
      properties:
        message:
          type: string
          example: OTP verified successfully
        data:
          type: object
          properties:
            accessToken:
              type: string
              example: eyJhbGciOiJIUzI1NiIsInR5cCI...
            refreshToken:
              type: string
              example: eyJhbGciOiJIUzI1NiIsInR5cCI...

    # Location autocomplete response
    SuccessLocationAutocompleteResponse:
      type: object
      properties:
        message:
          type: string
          example: Locations fetched successfully
        data:
          type: array
          items:
            type: object
            properties:
              addressId:
                type: integer
                example: 123
              name:
                type: string
                example: Home
              addressLine1:
                type: string
                example: "123, MG Road"
              city:
                type: string
                example: Bangalore
              state:
                type: string
                example: Karnataka
              country:
                type: string
                example: India
              pinCode:
                type: string
                example: "560001"
              latitude:
                type: number
                example: 12.9716
              longitude:
                type: number
                example: 77.5946
        total:
          type: integer
          example: 1
        page:
          type: integer
          example: 1
        limit:
          type: integer
          example: 10

    # Reverse geocode / add address response
    SuccessAddressResponse:
      type: object
      properties:
        message:
          type: string
          example: Address fetched successfully
        data:
          type: object
          properties:
            addressId:
              type: integer
              example: 123
            name:
              type: string
              example: Home
            addressLine1:
              type: string
              example: "123, MG Road"
            city:
              type: string
              example: Bangalore
            state:
              type: string
              example: Karnataka
            country:
              type: string
              example: India
            pinCode:
              type: string
              example: "560001"
            latitude:
              type: number
              example: 12.9716
            longitude:
              type: number
              example: 77.5946

    # Selected address response (when selecting an address)
    SuccessSelectedAddressResponse:
      type: object
      properties:
        message:
          type: string
          example: Address selected successfully
        data:
          type: object
          properties:
            selectedAddressId:
              type: integer
              example: 123

    # Cars list (paginated)
    SuccessCarsResponse:
      type: object
      properties:
        message:
          type: string
          example: Cars fetched successfully
        data:
          type: array
          items:
            type: object
            properties:
              id: { type: integer, example: 1 }
              model: { type: string, example: "Camry" }
              makeId: { type: integer, example: 5 }
              makeName: { type: string, example: "Toyota" }
              categoryId: { type: integer, example: 2 }
              categoryName: { type: string, example: "Sedan" }
        total:
          type: integer
          example: 124
        page:
          type: integer
          example: 1
        limit:
          type: integer
          example: 10

    # Car brands paginated response
    SuccessCarBrandsResponse:
      type: object
      properties:
        message:
          type: string
          example: Car brands fetched successfully
        data:
          type: array
          items:
            type: object
            properties:
              id:
                type: integer
                example: 1
              name:
                type: string
                example: Toyota
        total:
          type: integer
          example: 20
        page:
          type: integer
          example: 1
        limit:
          type: integer
          example: 10

      #Service Added
    AddServiceRequest:
      type: object
      required:
        - name
        - displayName
        - imageId
        - targetValue
      properties:
        name:
          type: string
          example: car_cleaning
        displayName:
          type: string
          example: Car Cleaning
        imageId:
          type: string
          example: 10
        targetValue:
          type: string
          example: 5

  
    SuccessAddServiceResponse:
      type: object
      properties:
        message:
          type: string
          example: Service added successfully
        data:
          type: object
          properties:
            id:
              type: integer
              example: 1
            name:
              type: string
              example: car_cleaning
            displayName:
              type: string
              example: Car Cleaning
            imageId:
              type: string
              example: 10
            targetValue:
              type: string
              example: 5
            isActive:
              type: boolean
              example: true


    # Standardized error schema (Option B)
    ErrorResponse:
      type: object
      properties:
        message:
          type: string
          example: Invalid request
        errorCode:
          type: string
          example: INVALID_REQUEST
        statusCode:
          type: integer
          example: 400

  responses:
    BadRequestError:
      description: Bad Request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            missing_param:
              summary: Missing parameter
              value:
                message: "Missing required parameter 'mobile'"
                errorCode: "MISSING_PARAM_MOBILE"
                statusCode: 400

    UnauthorizedError:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            invalid_token:
              summary: Invalid or missing token
              value:
                message: "Invalid or missing access token"
                errorCode: "UNAUTHORIZED"
                statusCode: 401

    NotFoundError:
      description: Resource Not Found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            not_found:
              summary: Resource not found
              value:
                message: "Resource not found"
                errorCode: "NOT_FOUND"
                statusCode: 404

    TooManyRequestsError:
      description: Too many requests / cooldown active
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            cooldown:
              summary: OTP resend blocked due to cooldown
              value:
                message: "OTP resend cooldown active"
                errorCode: "OTP_RESEND_COOLDOWN"
                statusCode: 429

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            server_error:
              summary: Generic server error
              value:
                message: "Something went wrong"
                errorCode: "INTERNAL_SERVER_ERROR"
                statusCode: 500
