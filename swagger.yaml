openapi: 3.0.0
info:
  title: Shinr User Management API
  version: "1.0.0"
  description: API documentation for login and OTP verification

servers:
  - url: https://shinr-user-mgmt.onrender.com/

tags:
  - name: Auth
    description: Authentication endpoints
  - name: User Profile
    description: User profile and location endpoints
  - name: Vehicle
    description: Vehicle-related endpoints for fetching car details

paths:
  /user/login/otp:
    post:
      tags:
        - Auth
      summary: Generate OTP for login
      description: Sends an OTP token for a mobile number. Creates user/device if not exists.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - mobile
              properties:
                mobile:
                  type: string
      responses:
        "200":
          description: OTP generated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  data:
                    type: object
                    properties:
                      otpToken:
                        type: string
        "400":
          description: Bad Request
        "500":
          description: OTP generation failed

  /user/login/verify-otp:
    post:
      tags:
        - Auth
      summary: Verify OTP and generate access & refresh tokens
      description: Verifies the OTP for a user device and returns JWT tokens.
      parameters:
        - in: header
          name: x-device-id
          required: true
          schema:
            type: string
          description: The unique ID of the device making the request
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - otpToken
                - otp
              properties:
                otpToken:
                  type: string
                otp:
                  type: string
      responses:
        "200":
          description: OTP verified successfully and tokens generated
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  data:
                    type: object
                    properties:
                      accessToken:
                        type: string
                      refreshToken:
                        type: string
        "400":
          description: Invalid OTP or token
        "500":
          description: OTP verification failed

  /user/login/resend-otp:
    post:
      tags:
        - Auth
      summary: Resend OTP for a user device
      description: |
        Resends an OTP for a user device. 
        Validates the device, checks request count and cooldown (45 seconds), and generates a new OTP and token.
      parameters:
        - in: header
          name: x-device-id
          required: true
          schema:
            type: string
          description: The unique ID of the device making the request
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - otpToken
              properties:
                otpToken:
                  type: string
                  description: The token from the previous OTP request
      responses:
        "200":
          description: OTP resent successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: OTP resent successfully
                  data:
                    type: object
                    properties:
                      otpToken:
                        type: string
                        description: New OTP token to be used for verification
        "400":
          description: Bad request due to invalid device or no active OTP
        "429":
          description: OTP request blocked due to cooldown or limit exceeded
        "500":
          description: Failed to resend OTP due to server error

  /user/login/generate-refreshToken:
    post:
      tags:
        - Auth
      summary: Refresh Access and Refresh Tokens
      description: >
        Refreshes the user's access and refresh tokens using a valid refresh token.  
        The endpoint validates the refresh token, device identity, and user status before issuing new tokens.
      parameters:
        - in: header
          name: x-device-id
          required: true
          schema:
            type: string
          description: The unique ID of the device making the request
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - refreshToken
              properties:
                refreshToken:
                  type: string
                  description: The refresh token issued during login.
      responses:
        "200":
          description: Tokens refreshed successfully.
        "400":
          description: Invalid request or token validation failed.
        "401":
          description: Unauthorized - Token is invalid or expired.
        "500":
          description: Internal Server Error - Token refresh failed unexpectedly.
      security: []

  /user/logout:
    post:
      tags:
        - Auth
      summary: Logout user and invalidate tokens
      description: |
        Logs out the currently authenticated user from the specified device.  
        Invalidates all active refresh tokens for that device and removes the device record from the database.
      security:
        - bearerAuth: []
      parameters:
        - in: header
          name: x-device-id
          required: true
          schema:
            type: string
          description: Unique device identifier for the user session
      responses:
        "200":
          description: Logged out successfully
        "401":
          description: Unauthorized - Missing or invalid access token
        "404":
          description: User or device not found
        "500":
          description: Logout failed

  /user-profile/location-autocomplete:
    get:
      tags:
        - User Profile
      summary: Get location suggestions by search query
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: search
          required: true
          schema:
            type: string
            minLength: 3
        - in: header
          name: x-device-id
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Autocomplete results fetched successfully
        "400":
          description: Invalid search parameter
        "401":
          description: Unauthorized
        "500":
          description: Failed to fetch autocomplete suggestions

  /user-profile/get-location/reverse-geocode:
    post:
      tags:
        - User Profile
      summary: Get address from latitude and longitude
      security:
        - bearerAuth: []
      parameters:
        - in: header
          name: x-device-id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [lat, lng]
              properties:
                lat:
                  type: string
                lng:
                  type: string
      responses:
        "201":
          description: Address fetched successfully
        "400":
          description: Invalid latitude or longitude
        "401":
          description: Unauthorized
        "500":
          description: Failed to fetch address

  /user-profile/add-address:
    post:
      tags:
        - User Profile
      summary: Add a new address for the user
      security:
        - bearerAuth: []
      parameters:
        - in: header
          name: x-device-id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
                - addressLine1
                - country
                - city
                - state
                - pinCode
                - latitude
                - longitude
              properties:
                nickName:
                  type: string
                name:
                  type: string
                addressLine1:
                  type: string
                country:
                  type: string
                city:
                  type: string
                state:
                  type: string
                pinCode:
                  type: string
                latitude:
                  type: number
                longitude:
                  type: number
      responses:
        "201":
          description: Address saved successfully
        "400":
          description: Validation or bad request
        "401":
          description: Unauthorized
        "500":
          description: Failed to save address

  /user-profile/remove-address/{id}:
    post:
      tags:
        - User Profile
      summary: Remove an address by ID
      security:
        - bearerAuth: []
      parameters:
        - in: header
          name: x-device-id
          required: true
          schema:
            type: string
        - in: path
          name: id
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Address removed successfully
        "400":
          description: Invalid address ID
        "401":
          description: Unauthorized
        "404":
          description: Address not found
        "500":
          description: Failed to remove address

  /user-profile/select-address/{id}:
    post:
      tags:
        - User Profile
      summary: Select an address by ID
      security:
        - bearerAuth: []
      parameters:
        - in: header
          name: x-device-id
          required: true
          schema:
            type: string
        - in: path
          name: id
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Address selected successfully
        "400":
          description: Invalid address ID
        "401":
          description: Unauthorized
        "404":
          description: Address not found
        "500":
          description: Failed to select address

  /car:
    get:
      tags:
        - Vehicle
      summary: Fetch cars with filtering, sorting, and pagination
      description: >
        Retrieves a list of active cars with category and make info.
      operationId: getCars
      security:
        - bearerAuth: []
      parameters:
        - name: x-device-id
          in: header
          required: true
          schema:
            type: string
        - name: search
          in: query
          schema:
            type: string
        - name: makeId
          in: query
          schema:
            type: integer
        - name: categoryId
          in: query
          schema:
            type: integer
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 10
        - name: sortOrder
          in: query
          schema:
            type: string
            enum: [asc, desc]
            default: asc
      responses:
        "200":
          description: Cars fetched successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: integer
                        model:
                          type: string
                        makeId:
                          type: integer
                        makeName:
                          type: string
                        categoryId:
                          type: integer
                        categoryName:
                          type: string
                  total:
                    type: integer
                  page:
                    type: integer
                  limit:
                    type: integer
        "401":
          description: Unauthorized
        "404":
          description: No cars found
        "500":
          description: Internal server error

  /cars/car-brands:
    get:
      tags:
        - Vehicle
      summary: Fetch car brands (makes)
      description: >
        Retrieves paginated list of car brands.
      operationId: getCarsBrandHandler
      security:
        - bearerAuth: []
      parameters:
        - in: header
          name: x-device-id
          required: true
          schema:
            type: string
        - in: query
          name: page
          schema:
            type: integer
            default: 1
        - in: query
          name: limit
          schema:
            type: integer
            default: 10
      responses:
        "200":
          description: Car brands fetched successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: integer
                          example: 1
                        name:
                          type: string
                          example: Toyota
                  total:
                    type: integer
                    example: 20
                  page:
                    type: integer
                    example: 1
                  limit:
                    type: integer
                    example: 10
        "401":
          description: Unauthorized
        "500":
          description: Failed to fetch car brands

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
